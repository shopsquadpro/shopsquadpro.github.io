<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 20px; }
        
        .config {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .config-header {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .toggle-arrow {
            margin-right: 8px;
            transition: transform 0.3s;
        }
        .toggle-arrow.collapsed { transform: rotate(-90deg); }
        .config-content {
            margin-top: 15px;
            overflow: hidden;
            transition: max-height 0.3s, opacity 0.3s;
        }
        .config-content.hidden {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }
        .config input {
            padding: 8px;
            width: 100%;
            max-width: 500px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 8px;
        }
        .config button {
            padding: 8px 15px;
            margin-top: 8px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 15px;
            font-size: 14px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #0056CC; }
        .export-btn {
            margin-bottom: 10px;
            font-size: 12px;
            padding: 6px 12px;
        }
        
        .result-section { margin-bottom: 30px; }
        .result-section h2 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #007AFF;
        }
        .results {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
            overflow-y: visible;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th,         td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            max-width: 300px;
            word-wrap: break-word;
            position: relative;
        }
        td.truncated {
            cursor: pointer;
        }
        td.full-text {
            white-space: normal;
            max-width: none;
        }
        th {
            background: #f9f9f9;
            font-weight: 600;
        }
        tr:hover { background: #f9f9f9; }
        td a {
            color: #007AFF;
            text-decoration: none;
        }
        td a:hover {
            text-decoration: underline;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 4px;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }
        .status.loading { background: #fff3cd; color: #856404; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .row-limit-notice {
            background: #e7f3ff;
            color: #004085;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“Š Analytics</h1>
        
        <div class="config">
            <div class="config-header" onclick="toggleConfig()">
                <span class="toggle-arrow" id="configArrow">â–¼</span>
                <strong>Configuration</strong>
            </div>
            <div class="config-content" id="configContent">
                <label>
                    Supabase Function URL:
                    <input type="text" id="functionUrl" placeholder="https://your-project.supabase.co/functions/v1/analytics" />
                </label><br>
                <label>
                    Supabase Anon Key:
                    <input type="password" id="anonKey" placeholder="Your Supabase anon key" />
                </label><br>
                <label>
                    Admin Password (optional):
                    <input type="password" id="adminPassword" placeholder="Leave empty if not configured" />
                </label><br>
                <button onclick="saveConfig()">Save Configuration</button>
            </div>
        </div>
        
        <div class="controls">
            <button onclick="loadAll()">Load All Analytics</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        // ============================================================================
        // CONFIGURATION - All queries and settings in one place
        // ============================================================================
        const CONFIG = {
            QUERIES: {
                ai_responses: 'AI Chat Responses',
                users_per_platform: 'Users per Platform',
                users_per_country_only: 'Users per Country',
                users_per_country: 'Users per Country and Platform',
                recipes: 'Recipes',
                users_plain: 'Users',
            },
            STORAGE_KEYS: {
                url: 'analyticsFunctionUrl',
                key: 'analyticsAnonKey',
                password: 'analyticsAdminPassword',
                expanded: 'configExpanded'
            },
            MAX_CELL_CHARS: 80,  // Maximum characters to display in table cells before truncation
            MAX_ROWS: 20  // Maximum rows to display per table
        };

        let allData = {};

        // ============================================================================
        // CONFIGURATION MANAGEMENT
        // ============================================================================
        function loadSavedConfig() {
            document.getElementById('functionUrl').value = localStorage.getItem(CONFIG.STORAGE_KEYS.url) || '';
            document.getElementById('anonKey').value = localStorage.getItem(CONFIG.STORAGE_KEYS.key) || '';
            document.getElementById('adminPassword').value = localStorage.getItem(CONFIG.STORAGE_KEYS.password) || '';
            
            const expanded = localStorage.getItem(CONFIG.STORAGE_KEYS.expanded);
            if (expanded === 'false') {
                document.getElementById('configContent').classList.add('hidden');
                document.getElementById('configArrow').classList.add('collapsed');
            }
        }

        function saveConfig() {
            localStorage.setItem(CONFIG.STORAGE_KEYS.url, document.getElementById('functionUrl').value);
            localStorage.setItem(CONFIG.STORAGE_KEYS.key, document.getElementById('anonKey').value);
            const password = document.getElementById('adminPassword').value;
            if (password) {
                localStorage.setItem(CONFIG.STORAGE_KEYS.password, password);
            } else {
                localStorage.removeItem(CONFIG.STORAGE_KEYS.password);
            }
            alert('Configuration saved!');
        }

        function toggleConfig() {
            const content = document.getElementById('configContent');
            const arrow = document.getElementById('configArrow');
            const isHidden = content.classList.contains('hidden');
            
            content.classList.toggle('hidden', !isHidden);
            arrow.classList.toggle('collapsed', isHidden);
            localStorage.setItem(CONFIG.STORAGE_KEYS.expanded, isHidden ? 'true' : 'false');
        }

        function getConfig() {
            const url = document.getElementById('functionUrl').value || localStorage.getItem(CONFIG.STORAGE_KEYS.url);
            const key = document.getElementById('anonKey').value || localStorage.getItem(CONFIG.STORAGE_KEYS.key);
            const password = document.getElementById('adminPassword').value || localStorage.getItem(CONFIG.STORAGE_KEYS.password) || '';
            return { url, key, password };
        }

        // ============================================================================
        // DATA LOADING
        // ============================================================================
        async function loadAll() {
            const config = getConfig();
            if (!config.url || !config.key) {
                document.getElementById('results').innerHTML = 
                    '<div class="error">Please configure Function URL and Anon Key first.</div>';
                return;
            }

            // Initialize UI
            const html = Object.keys(CONFIG.QUERIES).map(queryKey => `
                <div class="result-section" id="section-${queryKey}">
                    <h2>${CONFIG.QUERIES[queryKey]} <span class="status loading" id="status-${queryKey}">Loading...</span></h2>
                    <div id="content-${queryKey}"><div class="loading">Loading...</div></div>
                </div>
            `).join('');
            document.getElementById('results').innerHTML = html;

            // Load all queries in parallel
            const promises = Object.keys(CONFIG.QUERIES).map(queryKey => 
                loadQuery(queryKey, config)
            );
            await Promise.all(promises);
        }

        async function loadQuery(queryKey, config) {
            try {
                const url = `${config.url}?query=${queryKey}` + 
                    (config.password ? `&password=${encodeURIComponent(config.password)}` : '');
                
                const headers = {
                    'Authorization': `Bearer ${config.key}`,
                    'apikey': config.key
                };
                if (config.password) {
                    headers['x-admin-password'] = config.password;
                }

                const response = await fetch(url, { headers });
                const json = await response.json();

                if (!response.ok) {
                    throw new Error(json.error || 'Request failed');
                }

                allData[queryKey] = json.data;
                updateSection(queryKey, json.data, null);
            } catch (error) {
                updateSection(queryKey, null, error.message);
            }
        }

        function updateSection(queryKey, data, error) {
            const statusEl = document.getElementById(`status-${queryKey}`);
            const contentEl = document.getElementById(`content-${queryKey}`);
            
            if (error) {
                statusEl.textContent = 'Error';
                statusEl.className = 'status error';
                contentEl.innerHTML = `<div class="error">Error: ${error}</div>`;
            } else {
                statusEl.textContent = `Loaded (${data?.length || 0} rows)`;
                statusEl.className = 'status success';
                contentEl.innerHTML = renderTable(data, queryKey);
            }
        }

        // ============================================================================
        // RENDERING
        // ============================================================================
        function renderTable(data, queryKey) {
            if (!data || data.length === 0) {
                return '<div class="loading">No data found.</div>';
            }

            const totalRows = data.length;
            const displayData = data.slice(0, CONFIG.MAX_ROWS);
            const keys = Object.keys(data[0]);
            const isUrl = (value) => {
                if (!value || typeof value !== 'string') return false;
                const str = value.trim();
                return str.startsWith('http://') || str.startsWith('https://');
            };

            const formatValue = (value, maxChars) => {
                if (value === null || value === undefined) return { text: '', full: '', isUrl: false };
                const fullText = Array.isArray(value) ? value.join(', ') : String(value);
                const url = isUrl(fullText);
                const text = fullText.length > maxChars ? fullText.substring(0, maxChars) + '...' : fullText;
                return { text, full: fullText, isTruncated: fullText.length > maxChars, isUrl: url };
            };

            const headers = keys.map(k => `<th>${k.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</th>`).join('');
            const rows = displayData.map((row, rowIndex) => {
                const cells = keys.map((k, cellIndex) => {
                    const { text, full, isTruncated, isUrl } = formatValue(row[k], CONFIG.MAX_CELL_CHARS);
                    const cellId = `cell-${queryKey}-${rowIndex}-${cellIndex}`;
                    const className = isTruncated && !isUrl ? 'truncated' : '';
                    
                    if (isUrl) {
                        return `<td id="${cellId}"><a href="${full.replace(/"/g, '&quot;')}" target="_blank" rel="noopener noreferrer">${text}</a></td>`;
                    }
                    
                    return `<td class="${className}" id="${cellId}" title="${full.replace(/"/g, '&quot;')}" onclick="expandCell('${cellId}')">${text}</td>`;
                }).join('');
                return `<tr>${cells}</tr>`;
            }).join('');

            const rowLimitNotice = totalRows > CONFIG.MAX_ROWS 
                ? `<div class="row-limit-notice">Showing ${CONFIG.MAX_ROWS} of ${totalRows} rows. Export CSV to see all data.</div>`
                : '';

            return `
                <button class="export-btn" onclick="exportData('${queryKey}')">Export CSV</button>
                ${rowLimitNotice}
                <div class="results">
                    <table>
                        <thead><tr>${headers}</tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        }

        // ============================================================================
        // CELL EXPANSION (for mobile)
        // ============================================================================
        function expandCell(cellId) {
            const cell = document.getElementById(cellId);
            if (!cell || !cell.classList.contains('truncated')) return;
            
            const fullText = cell.getAttribute('title');
            cell.textContent = fullText;
            cell.classList.remove('truncated');
            cell.classList.add('full-text');
            cell.removeAttribute('onclick');
        }

        // ============================================================================
        // EXPORT
        // ============================================================================
        function exportData(queryKey) {
            const data = allData[queryKey];
            if (!data || data.length === 0) return;

            const keys = Object.keys(data[0]);
            const formatValue = (value) => {
                if (value === null || value === undefined) return '';
                const str = Array.isArray(value) ? value.join(', ') : String(value);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return `"${str.replace(/"/g, '""')}"`;
                }
                return str;
            };

            const headers = keys.join(',');
            const rows = data.map(row => keys.map(k => formatValue(row[k])).join(','));
            const csv = [headers, ...rows].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${queryKey}-${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        window.addEventListener('load', () => {
            loadSavedConfig();
            const config = getConfig();
            if (config.url && config.key) {
                loadAll();
            }
        });
    </script>
</body>
</html>
